name: WOZ Harness Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: python -m pip install --upgrade pip
      - run: python -m pip install terminaluse pyyaml
      - run: tu --version
      - name: Render dynamic WOZ config
        env:
          WOZ_HARNESS_AGENT_NAME: ${{ vars.WOZ_HARNESS_AGENT_NAME }}
        run: |
          python - <<'PY'
          import os
          from pathlib import Path
          import yaml

          workspace = Path(os.environ.get("GITHUB_WORKSPACE", ".")).resolve()
          source = workspace / "config.yaml"
          if not source.exists():
              raise SystemExit(f"config.yaml missing at {source}")

          name = os.environ.get("WOZ_HARNESS_AGENT_NAME", "").strip()
          if not name:
              raise SystemExit("WOZ_HARNESS_AGENT_NAME missing")

          dockerfile_rel = "Dockerfile"
          if not (workspace / dockerfile_rel).exists():
              raise SystemExit(f"Dockerfile missing at {(workspace / dockerfile_rel)}")

          cfg = yaml.safe_load(source.read_text()) or {}
          if not isinstance(cfg, dict):
              raise SystemExit("config.yaml must be a YAML object")

          agent = cfg.setdefault("agent", {})
          if not isinstance(agent, dict):
              raise SystemExit("config.yaml agent must be an object")
          agent["name"] = name

          build = cfg.setdefault("build", {})
          if not isinstance(build, dict):
              raise SystemExit("config.yaml build must be an object")

          context = build.setdefault("context", {})
          if not isinstance(context, dict):
              raise SystemExit("config.yaml build.context must be an object")

          context["root"] = "."
          context["include_paths"] = ["."]
          context["dockerfile"] = dockerfile_rel
          dockerignore_rel = (Path(dockerfile_rel).parent / ".dockerignore").as_posix()
          if (workspace / dockerignore_rel).exists():
              context["dockerignore"] = dockerignore_rel
          elif "dockerignore" in context:
              del context["dockerignore"]

          out = workspace / ".woz-config.generated.yaml"
          out.write_text(yaml.safe_dump(cfg, sort_keys=False))
          print(f"rendered config: {out}")
          PY
      - name: Deploy harness
        env:
          TERMINALUSE_API_KEY: ${{ vars.WOZ_TERMINALUSE_API_KEY }}
          TERMINALUSE_BASE_URL: ${{ vars.WOZ_TERMINALUSE_BASE_URL }}
        run: tu deploy --config "$GITHUB_WORKSPACE/.woz-config.generated.yaml" --yes
